<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>__TITLE__</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    margin: 1.5rem;
    background: #0b1120;
    color: #e5e7eb;
}

h1 {
    margin-bottom: 0.25rem;
}

.subtitle {
    color: #9ca3af;
    margin-bottom: 1.5rem;
}

.container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
}

table.dataTable thead th {
    background-color: #111827;
    color: #e5e7eb;
}

table.dataTable tbody tr {
    background-color: #020617;
    color: #e5e7eb;
}

table.dataTable {
    border-collapse: collapse;
    width: 100%;
}

table.dataTable tbody tr:nth-child(even) {
    background-color: #020617;
}

table.dataTable tbody tr:nth-child(odd) {
    background-color: #020617;
}

table.dataTable tbody tr:hover {
    background-color: #111827;
}

.tag-KEEP {
    background-color: #166534;
    color: #dcfce7;
    padding: 0.15rem 0.4rem;
    border-radius: 999px;
    font-size: 0.75rem;
}

.tag-DELETE {
    background-color: #7f1d1d;
    color: #fee2e2;
    padding: 0.15rem 0.4rem;
    border-radius: 999px;
    font-size: 0.75rem;
}

.tag-MAYBE {
    background-color: #92400e;
    color: #ffedd5;
    padding: 0.15rem 0.4rem;
    border-radius: 999px;
    font-size: 0.75rem;
}

.tag-UNKNOWN {
    background-color: #374151;
    color: #e5e7eb;
    padding: 0.15rem 0.4rem;
    border-radius: 999px;
    font-size: 0.75rem;
}

.poster-img {
    width: 50px;
    height: auto;
    border-radius: 0.25rem;
    object-fit: cover;
}

.badge {
    display: inline-flex;
    padding: 0.1rem 0.4rem;
    border-radius: 999px;
    font-size: 0.7rem;
    background-color: #1f2937;
    color: #e5e7eb;
}

.charts {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.chart-card {
    background-color: #020617;
    border-radius: 0.75rem;
    padding: 1rem;
    box-shadow: 0 10px 25px rgba(0,0,0,0.6);
    border: 1px solid #1f2937;
}

.chart-card h3 {
    margin-top: 0;
    margin-bottom: 0.75rem;
}

@media (max-width: 1024px) {
    .container {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>

<h1>__TITLE__</h1>
<p class="subtitle">__SUBTITLE__</p>

<div class="container">
  <div>
    <table id="movies" class="display" style="width:100%">
      <thead>
        <tr>
          <th>Poster</th>
          <th>Library</th>
          <th>Title</h5>
          <th>Year</th>
          <th>IMDb</th>
          <th>RT</th>
          <th>IMDb votes</th>
          <th>Decision</th>
          <th>Reason</th>
          <th>MisID hint</th>
          <th>File</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="charts">
    <div class="chart-card">
      <h3>Decisiones</h3>
      <canvas id="decisionChart"></canvas>
    </div>
    <div class="chart-card">
      <h3>Películas por biblioteca</h3>
      <canvas id="libraryChart"></canvas>
    </div>
  </div>
</div>

<!-- Aquí insertamos el JSON generado por Python -->
<script id="rows-data" type="application/json">__ROWS_JSON__</script>

<script>
// Datos generados por Python
const rows = JSON.parse(document.getElementById("rows-data").textContent || "[]");

// Construcción de tabla
const tableData = rows.map(r => {
  const poster = r.poster_url
    ? `<img src="${r.poster_url}" class="poster-img" loading="lazy">`
    : "";

  const decisionClass = r.decision ? `tag-${r.decision}` : "tag-UNKNOWN";
  const decisionLabel = r.decision || "UNKNOWN";

  const imdbRating = (r.imdb_rating != null && typeof r.imdb_rating === 'number')
    ? r.imdb_rating.toFixed(1)
    : (r.imdb_rating ?? "");

  const rtScore = (r.rt_score != null && r.rt_score !== "")
    ? `${r.rt_score}%`
    : "";

  const imdbVotes = (r.imdb_votes != null && !isNaN(Number(r.imdb_votes)))
    ? Number(r.imdb_votes).toLocaleString()
    : "";

  return [
    poster,
    r.library || "",
    r.title || "",
    r.year || "",
    imdbRating,
    rtScore,
    imdbVotes,
    `<span class="${decisionClass}">${decisionLabel}</span>`,
    r.reason || "",
    r.misidentified_hint || "",
    r.file || "",
  ];
});

$(document).ready(function() {
  $('#movies').DataTable({
    data: tableData,
    pageLength: 25,
    order: [[4, 'asc']], // IMDb ascendente (peores primero)
  });
});

// Gráfico de decisiones
(function() {
  const counts = {};
  for (const r of rows) {
    const d = r.decision || "UNKNOWN";
    counts[d] = (counts[d] || 0) + 1;
  }
  const labels = Object.keys(counts);
  const values = labels.map(k => counts[k]);

  const ctx = document.getElementById('decisionChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Número de películas',
        data: values,
      }],
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
      },
      scales: {
        x: {
          ticks: { color: '#e5e7eb' },
          grid: { color: '#1f2937' },
        },
        y: {
          ticks: { color: '#e5e7eb' },
          grid: { color: '#1f2937' },
        },
      },
    },
  });
})();

// Gráfico por biblioteca (top 10)
(function() {
  const counts = {};
  for (const r of rows) {
    const lib = r.library || 'Unknown';
    counts[lib] = (counts[lib] || 0) + 1;
  }
  const entries = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10);
  const labels = entries.map(e => e[0]);
  const values = entries.map(e => e[1]);

  const ctx = document.getElementById('libraryChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Películas',
        data: values,
      }],
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        legend: { display: false },
      },
      scales: {
        x: {
          ticks: { color: '#e5e7eb' },
          grid: { color: '#1f2937' },
        },
        y: {
          ticks: { color: '#e5e7eb' },
          grid: { color: '#1f2937' },
        },
      },
    },
  });
})();
</script>

</body>
</html>